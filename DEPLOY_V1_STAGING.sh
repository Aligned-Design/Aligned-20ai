#!/bin/bash
# ğŸš€ V1 STAGING DEPLOYMENT - ROBUST DEMO MODE
# Run these commands manually (Fly CLI not accessible in build environment)

set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸš€ V1 STAGING DEPLOYMENT - DEMO MODE (Server Safety First)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "ğŸ“‹ STEP 1: Set Secrets (Staging)"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Run these commands:"
echo ""
echo "fly secrets set VITE_DEMO_MODE=true SERVER_DEMO_MODE=true VITE_FEATURE_UNIFIED_DASH=true"
echo ""
echo "Why both flags?"
echo "  â€¢ VITE_DEMO_MODE=true     â†’ Client bypasses Supabase (compile-time)"
echo "  â€¢ SERVER_DEMO_MODE=true   â†’ Server uses stub client (runtime)"
echo "  â€¢ VITE_FEATURE_UNIFIED_DASH=true â†’ Enables unified dashboard"
echo ""
echo "Verify secrets are set:"
echo "fly secrets list"
echo ""
read -p "Press Enter after setting secrets..."
echo ""

echo "ğŸ“¦ STEP 2: Deploy with Cache Bust"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Run this command:"
echo ""
echo "fly deploy --build-arg NO_CACHE=\$(date +%s)"
echo ""
echo "Expected output:"
echo "  âœ“ client built in ~11s"
echo "  âœ“ server built in ~0.3s"
echo "  ==> Successfully deployed"
echo ""
read -p "Press Enter after deployment completes..."
echo ""

echo "ğŸ” STEP 3: Verify Server Logs"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Run this command:"
echo ""
echo "fly logs --since 5m | grep -E 'DEMO MODE|Supabase'"
echo ""
echo "Expected output (GOOD SIGNS âœ…):"
echo "  [DEMO MODE] Server bypassing Supabase - using stub client"
echo "  ğŸš€ Fusion Starter server running on port 8080"
echo ""
echo "Red flags (BAD - report if you see these âŒ):"
echo "  Error: Missing SUPABASE_URL"
echo "  TypeError: Failed to fetch"
echo "  Invalid API key"
echo ""
read -p "Press Enter after verifying logs..."
echo ""

echo "ğŸ¥ STEP 4: Health Check"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Run this command (replace YOUR_APP with your Fly app name):"
echo ""
echo "curl -sI https://YOUR_APP.fly.dev/health"
echo ""
echo "Expected: HTTP/2 200"
echo ""
read -p "Press Enter after health check passes..."
echo ""

echo "ğŸŒ STEP 5: Staging Validation (Fast Path)"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Open in browser: https://YOUR_APP.fly.dev/dashboard"
echo ""
echo "Browser DevTools â†’ Console Tab:"
echo "  âœ… [DEMO MODE] Using mock auth user"
echo "  âœ… [DEMO MODE] Using mock brands"
echo "  âœ… [Analytics] dash_view: { ..., demo_mode: true }"
echo "  âŒ NO Supabase errors"
echo ""
echo "Browser DevTools â†’ Network Tab:"
echo "  1. Filter by 'supabase.co'"
echo "  2. Expected: 0 requests to Supabase"
echo "  3. All /api/* calls return 200"
echo ""
echo "Test all 4 core routes:"
echo "  â€¢ /dashboard        â†’ KPIs render"
echo "  â€¢ /analytics        â†’ Charts display"
echo "  â€¢ /admin/billing    â†’ Table loads"
echo "  â€¢ /client-portal    â†’ Read-only (no edit/delete buttons)"
echo ""
echo "Test interactions:"
echo "  â€¢ Toggle light/dark mode â†’ colors legible + on-brand"
echo "  â€¢ Change brand selector â†’ all cards update"
echo "  â€¢ Change period picker â†’ all charts update"
echo ""
read -p "Press Enter after validation..."
echo ""

echo "ğŸ“¸ STEP 6: Capture Proof Artifacts"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Screenshots (8 total):"
echo "  Desktop (1920x1080) - Light mode:"
echo "    â€¢ /dashboard"
echo "    â€¢ /analytics"
echo "  Desktop (1920x1080) - Dark mode:"
echo "    â€¢ /dashboard"
echo "    â€¢ /analytics"
echo "  Mobile (375x667) - Light mode:"
echo "    â€¢ /dashboard"
echo "    â€¢ /client-portal"
echo "  Mobile (375x667) - Dark mode:"
echo "    â€¢ /dashboard"
echo "    â€¢ /client-portal"
echo ""
echo "Looms (4 videos, â‰¤2 min each):"
echo "  1. Agency Flow:"
echo "     - Load /dashboard â†’ show KPIs"
echo "     - Navigate /analytics â†’ show charts"
echo "     - Visit /content-queue"
echo "     - Visit /approvals"
echo "     - Export CSV"
echo ""
echo "  2. Client Flow:"
echo "     - Load /client-portal"
echo "     - Verify NO edit/delete buttons"
echo "     - Export data"
echo "     - Show console (clean)"
echo ""
echo "  3. Filter Sync Demo:"
echo "     - Change brand: Acme Corp â†’ GreenLeaf Organics"
echo "     - All KPIs update simultaneously"
echo "     - Change period: Week â†’ Month"
echo "     - All charts update simultaneously"
echo "     - Show console analytics events"
echo ""
echo "  4. Dark Mode + Mobile:"
echo "     - Toggle dark mode"
echo "     - Verify contrast/colors"
echo "     - Mobile viewport (375px)"
echo "     - Navigate routes"
echo ""
echo "Performance (Lighthouse - Mobile, Throttled):"
echo "  Pages: /dashboard, /analytics"
echo "  Capture: LCP, INP, CLS scores"
echo "  Targets: LCP <2.0s, INP <150ms, CLS <0.1"
echo ""
echo "A11y (axe DevTools):"
echo "  Pages: /dashboard, /analytics, /admin/billing, /client-portal"
echo "  Expected: 0 serious/critical violations"
echo ""
echo "Telemetry (Console Screenshot):"
echo "  Filter console by '[Analytics]'"
echo "  Verify events:"
echo "    â€¢ dash_view"
echo "    â€¢ dash_filter_applied"
echo "    ï¿½ï¿½ dash_brand_switched"
echo "    â€¢ dash_export (if wired)"
echo "  All events must include: demo_mode: true"
echo ""
echo "Build Logs:"
echo "  fly logs --since 5m > staging-build-logs.txt"
echo "  Capture last 20 lines showing clean startup"
echo ""
read -p "Press Enter after capturing all artifacts..."
echo ""

echo "ğŸ”§ STEP 7: Edge Polish (10 min)"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Server console hygiene:"
echo "  âœ… Only ONE [DEMO MODE] log per context on first load"
echo "  âœ… No duplicate/verbose logs"
echo ""
echo "Secrets hygiene:"
echo "  Search dist bundle for leaked secrets:"
echo "  grep -r 'supabase' dist/ | grep -v 'demo.supabase.co'"
echo "  Expected: No matches (or only demo URL)"
echo ""
echo "Flags independence:"
echo "  Test both combinations on staging:"
echo "  â€¢ VITE_DEMO_MODE=true + VITE_FEATURE_UNIFIED_DASH=false"
echo "  â€¢ VITE_DEMO_MODE=true + VITE_FEATURE_UNIFIED_DASH=true"
echo "  Demo mode must not force unified flag"
echo ""
read -p "Press Enter after polish..."
echo ""

echo "âœ… STEP 8: Post GO Note"
echo "â”€â”€ï¿½ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Reply in chat with this format:"
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "âœ… V1 STAGING LIVE"
echo ""
echo "**Staging URL:** https://YOUR_APP.fly.dev"
echo "**Deployed At:** $(date)"
echo "**Build Time:** ~11s (client) + ~0.3s (server)"
echo ""
echo "**Flags Set:**"
echo "âœ… VITE_DEMO_MODE=true"
echo "âœ… SERVER_DEMO_MODE=true"
echo "âœ… VITE_FEATURE_UNIFIED_DASH=true"
echo ""
echo "**Server Logs:**"
echo "âœ… [DEMO MODE] Server bypassing Supabase - using stub client"
echo "âœ… ğŸš€ Fusion Starter server running on port 8080"
echo ""
echo "**Client Console:**"
echo "âœ… [DEMO MODE] Using mock auth user"
echo "âœ… [DEMO MODE] Using mock brands"
echo "âœ… [Analytics] dash_view: { ..., demo_mode: true }"
echo ""
echo "**Network Tab:**"
echo "âœ… 0 requests to supabase.co"
echo "âœ… All /api/* endpoints returning 200"
echo ""
echo "**Routes Verified:**"
echo "âœ… /dashboard - KPIs render, no errors"
echo "âœ… /analytics - Charts display with mock data"
echo "âœ… /admin/billing - Billing table loads"
echo "âœ… /client-portal - Read-only enforced (no edit/delete CTAs)"
echo ""
echo "**Interactions:**"
echo "âœ… Light/dark toggle â†’ legible + on-brand"
echo "âœ… Brand selector â†’ all cards update"
echo "âœ… Period picker â†’ all charts update"
echo ""
echo "**Proof Artifacts:**"
echo "ğŸ“¸ Screenshots: [8 attached/linked]"
echo "ğŸ¬ Looms: [4 videos, â‰¤2 min each]"
echo "âš¡ Lighthouse: LCP [X]s, INP [X]ms, CLS [X]"
echo "â™¿ axe: 0 serious/critical violations"
echo "ğŸ“Š Telemetry: All events tagged demo_mode: true"
echo "ğŸ“ Build logs: [attached - last 20 lines clean]"
echo ""
echo "**Known Issues:**"
echo "- None blocking V1 âœ…"
echo ""
echo "**Next Steps:**"
echo "- Review proof artifacts"
echo "- Get stakeholder sign-off"
echo "- Plan production canary rollout"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ï¿½ï¿½ï¿½â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ¯ DEPLOYMENT COMPLETE - READY FOR V1 STAGING VALIDATION"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "All steps completed. Post the GO note above in chat."
echo ""
